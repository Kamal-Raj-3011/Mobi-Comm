<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Language" content="en">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobi-Comm - Plan Management</title>
    <link rel="stylesheet" href="assets/css/planmanagement.css">
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <script src="node_modules/@popperjs/core/dist/umd/popper.min.js"></script>
    <style>
        @media (max-width: 991px) {
            #sidebar {
                display: none;
            }
            .container-fluid {
                margin-left: 0 !important;
                max-width: 100% !important;
            }
        }
    </style>
</head>

<body>
<!-- Sidebar (Offcanvas for Mobile) -->
<div class="offcanvas offcanvas-start d-lg-none bg-dark text-white p-4 shadow-lg" id="offcanvasSidebar" style="width: 250px;">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title text-info"><i class="fas fa-user-shield me-2"></i> Admin Panel</h5>
        <button type="button" class="btn-close text-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <div class="list-group">
            <a href="admindashboard.html" class="list-group-item list-group-item-action d-flex align-items-center gap-2">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="user.html" class="list-group-item list-group-item-action d-flex align-items-center gap-2">
                <i class="fas fa-users"></i> All Users
            </a>
            <a href="planmanagement.html" class="list-group-item active list-group-item-action d-flex align-items-center gap-2">
                <i class="fas fa-list-alt"></i> Plan Management
            </a>
            <a href="adminreport.html" class="list-group-item list-group-item-action d-flex align-items-center gap-2">
                <i class="fas fa-list-alt"></i> Report
            </a>
        </div>
    </div>
</div>

<!-- Sidebar (Fixed for Large Screens) -->
<div class="d-none d-lg-block bg-dark text-white p-4 shadow-lg" id="sidebar" style="width: 250px; min-height: 100vh; position: fixed;">
    <h3 class="text-center py-3 text-info"><i class="fas fa-user-shield me-2"></i> Admin Panel</h3>
    <div class="list-group">
        <a href="admindashboard.html" class="list-group-item list-group-item-action d-flex align-items-center gap-2">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a href="user.html" class="list-group-item list-group-item-action d-flex align-items-center gap-2">
            <i class="fas fa-users"></i> All Users
        </a>
        <a href="planmanagement.html" class="list-group-item active list-group-item-action d-flex align-items-center gap-2">
            <i class="fas fa-list-alt"></i> Plan Management
        </a>
        <a href="adminreport.html" class="list-group-item  list-group-item-action d-flex align-items-center gap-2">
            <i class="fas fa-list-alt"></i> Report
        </a>
    </div>
</div>
    

    <!-- Page Content -->
    <div class="container-fluid" style="margin-left: 238px; max-width: calc(100% - 240px);">
        <nav class="navbar navbar-dark bg-dark">
            <div class="container-fluid">
                <button class="btn btn-dark d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <a class="navbar-brand" href="home.html">Mobi-Comm</a>
                <div class="dropdown">
                    <button class="btn btn-dark dropdown-toggle" type="button" id="adminDropdown" data-bs-toggle="dropdown">
                        Admin Profile
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="admin.html">Logout</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <h2 class="my-4 text-center">Plan Management</h2>

        <!-- Category Management -->
        <div class="container mt-4">

            <!-- Add Category Button -->
            <div class="text-end mb-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                    Add Category <i class="fas fa-plus"></i>
                </button>
            </div>
        
            <!-- Categories Table -->
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>S.No</th>
                            <th>Category Name</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="categoryTableBody">
                        <!-- Categories will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
        

        <!-- Plans Management -->
        <div class="container mt-4">

            <!-- Add Plan Button -->
            <div class="text-end mb-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPlanModal">
                    Add Plan <i class="fas fa-plus"></i>
                </button>
            </div>
        
            <!-- Nav Tabs -->
            <ul class="nav nav-tabs mb-3" id="planTabs">
                <li class="nav-item">
                    <a class="nav-link active" id="active-plans-tab" data-bs-toggle="tab" href="#activePlans">Active Plans</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="inactive-plans-tab" data-bs-toggle="tab" href="#inactivePlans">Inactive Plans</a>
                </li>
            </ul>
        
            <!-- Tab Content -->
            <div class="tab-content">
                
                <!-- Active Plans Tab -->
                <div class="tab-pane fade show active" id="activePlans">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>S.No</th>
                                    <th>Plan Category</th>
                                    <th>Price</th>
                                    <th>Data</th>
                                    <th>Calls</th>
                                    <th>Validity</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="activePlansTableBody">
                                <!-- Active plans will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
        
                <!-- Inactive Plans Tab -->
                <div class="tab-pane fade" id="inactivePlans">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>S.No</th>
                                    <th>Plan Category</th>
                                    <th>Price</th>
                                    <th>Data</th>
                                    <th>Calls</th>
                                    <th>Validity</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="inactivePlansTableBody">
                                <!-- Inactive plans will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
        
            </div>
        
        </div>
        

        <!-- Modal to Add a New Category -->
        <div class="modal fade" id="addCategoryModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Category</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addCategoryForm">
                            <div class="mb-3">
                                <label class="form-label">Category Name</label>
                                <input type="text" class="form-control" id="categoryName" required>
                            </div>
                            <!-- Centered Button -->
                            <div class="text-center mt-3">
                                <button type="submit" class="btn btn-success px-4">Add Category</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        

        <!-- Modal to Add a New Plan -->
        <div class="modal fade" id="addPlanModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Recharge Plan</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addPlanForm">
                            <div class="row">
                                <!-- Left Section -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Category Type</label>
                                        <select class="form-select" id="categoryType" required>
                                            <option value="">Select Category</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Data</label>
                                        <input type="text" class="form-control" id="data">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">SMS</label>
                                        <input type="text" class="form-control" id="sms">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Additional Features</label>
                                        <input type="text" class="form-control" id="additionalFeatures">
                                    </div>
                                </div>
                                
                                <!-- Right Section -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Price</label>
                                        <input type="number" class="form-control" id="price" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Calls</label>
                                        <input type="text" class="form-control" id="calls">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Validity</label>
                                        <input type="number" class="form-control" id="validity" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Tag</label>
                                        <input type="text" class="form-control" id="tag">
                                    </div>
                                </div>
                            </div>
        
                            <!-- Centered Button -->
                            <div class="text-center mt-3">
                                <button type="submit" class="btn btn-success px-4">Add Plan</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Edit Category Modal -->
        <div class="modal fade" id="editCategoryModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Category</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editCategoryForm">
                            <div class="mb-3">
                                <label class="form-label">Category Name</label>
                                <input type="text" class="form-control" id="editCategoryName" required>
                            </div>
                            <div class="text-center mt-3">
                                <button type="submit" class="btn btn-success px-4">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Plan Modal -->
        <div class="modal fade" id="editPlanModal" tabindex="-1" aria-labelledby="editPlanModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title" id="editPlanModalLabel">Edit Plan</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editPlanForm">
                            <!-- Hidden Input for Plan ID -->
                            <input type="hidden" id="editPlanId">

                            <!-- Category -->
                            <div class="mb-3">
                                <label for="editCategoryType" class="form-label">Category</label>
                                <select class="form-select" id="editCategoryType" required>
                                    <option value="">Select Category</option>
                                    <!-- Categories will be populated dynamically -->
                                </select>
                            </div>

                            <!-- Price -->
                            <div class="mb-3">
                                <label for="editPrice" class="form-label">Price</label>
                                <input type="number" class="form-control" id="editPrice" required>
                            </div>

                            <!-- Data -->
                            <div class="mb-3">
                                <label for="editData" class="form-label">Data (GB)</label>
                                <input type="text" class="form-control" id="editData" required>
                            </div>

                            <!-- Calls -->
                            <div class="mb-3">
                                <label for="editCalls" class="form-label">Calls</label>
                                <input type="text" class="form-control" id="editCalls" required>
                            </div>

                            <!-- SMS -->
                            <div class="mb-3">
                                <label for="editSms" class="form-label">SMS</label>
                                <input type="text" class="form-control" id="editSms">
                            </div>

                            <!-- Validity -->
                            <div class="mb-3">
                                <label for="editValidity" class="form-label">Validity (Days)</label>
                                <input type="number" class="form-control" id="editValidity" required>
                            </div>

                            <!-- Additional Features -->
                            <div class="mb-3">
                                <label for="editAdditionalFeatures" class="form-label">Additional Features</label>
                                <input type="text" class="form-control" id="editAdditionalFeatures">
                            </div>

                            <!-- Tag -->
                            <div class="mb-3">
                                <label for="editTag" class="form-label">Tag</label>
                                <input type="text" class="form-control" id="editTag">
                            </div>

                            <!-- Submit Button -->
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-warning">Update Plan</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- TOAST -->
        <div id="toastContainer" class="position-fixed bottom-0 end-0 p-3"></div>

    </div>

    <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>


<script>
document.addEventListener("DOMContentLoaded", function () {
    const categoryTableBody = document.getElementById("categoryTableBody");
    const addCategoryForm = document.getElementById("addCategoryForm");
    const categoryNameInput = document.getElementById("categoryName");
    const editCategoryForm = document.getElementById("editCategoryForm");
    const editCategoryNameInput = document.getElementById("editCategoryName");
    let currentCategoryId = null;

    const API_URL = "http://localhost:9090/api/categories";

    function showToast(message, type) {
        const toastContainer = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = `toast align-items-center text-white bg-${type} border-0 show`;
        toast.setAttribute("role", "alert");
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function fetchCategories() {
        fetch(API_URL + "/")
            .then(response => response.json())
            .then(categories => {
                categoryTableBody.innerHTML = "";
                categories.forEach((category) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${category.categoryId}</td>
                        <td>${category.categoryName}</td>
                        <td>${category.status}</td>
                        <td>
                            <button class="btn btn-warning btn-sm edit-category my-1" 
                                data-id="${category.categoryId}" data-name="${category.categoryName}" 
                                data-bs-toggle="modal" data-bs-target="#editCategoryModal">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn toggle-status my-1 btn-sm ${category.status === 'ACTIVE' ? 'btn-success' : 'btn-danger'}"
                                data-id="${category.categoryId}" data-status="${category.status}">
                                ${category.status === 'ACTIVE' ? 'Deactivate' : 'Activate'}
                            </button>
                            <button class="btn btn-danger btn-sm delete-category" data-id="${category.categoryId}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                    categoryTableBody.appendChild(row);
                });

                document.querySelectorAll(".toggle-status").forEach(button => {
                    button.addEventListener("click", function () {
                        const categoryId = this.getAttribute("data-id");
                        const currentStatus = this.getAttribute("data-status");
                        const newStatus = currentStatus === "ACTIVE" ? "INACTIVE" : "ACTIVE";
                        if (confirm(`Are you sure you want to ${newStatus === "ACTIVE" ? "Activate" : "Deactivate"}?`)) {
                            updateCategoryStatus(categoryId, newStatus);
                        }
                    });
                });

                document.querySelectorAll(".edit-category").forEach(button => {
                    button.addEventListener("click", function () {
                        currentCategoryId = this.getAttribute("data-id");
                        editCategoryNameInput.value = this.getAttribute("data-name");
                    });
                });

                document.querySelectorAll(".delete-category").forEach(button => {
                    button.addEventListener("click", function () {
                        const categoryId = this.getAttribute("data-id");
                        if (confirm("Are you sure you want to delete this category?")) {
                            deleteCategory(categoryId);
                        }
                    });
                });
            })
            .catch(error => console.error("Error fetching categories:", error));
    }

    function updateCategoryStatus(categoryId, newStatus) {
        fetch(`${API_URL}/${categoryId}/${newStatus.toLowerCase()}`, { method: "PUT" })
            .then(() => {
                showToast(`Category status updated to ${newStatus}`, "info");
                fetchCategories();
            })
            .catch(error => console.error("Error updating category status:", error));
    }

    editCategoryForm.addEventListener("submit", function (event) {
        event.preventDefault();
        const updatedCategory = { categoryName: editCategoryNameInput.value.trim() };
        fetch(`${API_URL}/update/${currentCategoryId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updatedCategory)
        })
        .then(() => {
            showToast("Category updated successfully", "warning");
            fetchCategories();
            let modal = bootstrap.Modal.getInstance(document.getElementById("editCategoryModal"));
            modal.hide();
        })
        .catch(error => console.error("Error updating category:", error));
    });

    addCategoryForm.addEventListener("submit", function (event) {
        event.preventDefault();
        const newCategory = { categoryName: categoryNameInput.value.trim() };
        fetch(API_URL + "/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newCategory)
        })
        .then(() => {
            showToast("Category added successfully", "success");
            fetchCategories();
            categoryNameInput.value = "";
            let modal = bootstrap.Modal.getInstance(document.getElementById("addCategoryModal"));
            modal.hide();
        })
        .catch(error => console.error("Error adding category:", error));
    });

    function deleteCategory(categoryId) {
        fetch(`${API_URL}/delete/${categoryId}`, { method: "DELETE" })
            .then(() => {
                showToast("Category deleted successfully", "danger");
                fetchCategories();
            })
            .catch(error => console.error("Error deleting category:", error));
    }

    fetchCategories();
});

</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
    const API_URL = "http://localhost:9090/api";
    const categoryDropdown = document.getElementById("categoryType");
    const addPlanForm = document.getElementById("addPlanForm");
    const editPlanForm = document.getElementById("editPlanForm");
    const activePlansTableBody = document.getElementById("activePlansTableBody");
    const inactivePlansTableBody = document.getElementById("inactivePlansTableBody");

    const editPlanId = document.getElementById("editPlanId");
    const editCategoryType = document.getElementById("editCategoryType");
    const editPrice = document.getElementById("editPrice");
    const editData = document.getElementById("editData");
    const editCalls = document.getElementById("editCalls");
    const editSms = document.getElementById("editSms");
    const editValidity = document.getElementById("editValidity");
    const editAdditionalFeatures = document.getElementById("editAdditionalFeatures");
    const editTag = document.getElementById("editTag");

    let currentPlanId = null;

    // Fetch Categories and Populate Dropdown
    function fetchCategories() {
        fetch(`${API_URL}/categories/`)
            .then(response => response.json())
            .then(categories => {
                categoryDropdown.innerHTML = `<option value="">Select Category</option>`;
                editCategoryType.innerHTML = `<option value="">Select Category</option>`;  // Also populate edit form dropdown
                categories.forEach(category => {
                    const option = `<option value="${category.categoryId}">${category.categoryName}</option>`;
                    categoryDropdown.innerHTML += option;
                    editCategoryType.innerHTML += option;
                });
            })
            .catch(error => console.error("Error fetching categories:", error));
    }

    // Fetch Plans and Display in Respective Tabs
    function fetchPlans() {
        fetch(`${API_URL}/plans/`)
            .then(response => response.json())
            .then(plans => {
                activePlansTableBody.innerHTML = "";
                inactivePlansTableBody.innerHTML = "";
                plans.forEach(plan => {
                    const row = `<tr>
                        <td>${plan.planId}</td>
                        <td>${plan.category.categoryName}</td>
                        <td>${plan.price}</td>
                        <td>${plan.data}</td>
                        <td>${plan.calls}</td>
                        <td>${plan.validity} days</td>
                        <td>
                            <button class="btn btn-warning btn-sm edit-plan my-1" data-id="${plan.planId}" data-bs-toggle="modal" data-bs-target="#editPlanModal"><i class="fas fa-edit me-1"></i>Edit</button>
                            <button class="btn btn-${plan.status === 'ACTIVE' ? 'danger' : 'success'} btn-sm toggle-status" data-id="${plan.planId}" data-status="${plan.status}">
                                ${plan.status === 'ACTIVE' ? 'Deactivate' : 'Activate'}
                            </button>
                        </td>
                    </tr>`;
                    if (plan.status === "ACTIVE") {
                        activePlansTableBody.innerHTML += row;
                    } else {
                        inactivePlansTableBody.innerHTML += row;
                    }
                });
            })
            .catch(error => console.error("Error fetching plans:", error));
    }

    // Add New Plan
    addPlanForm.addEventListener("submit", function (event) {
        event.preventDefault();
        const newPlan = {
            category: { categoryId: categoryDropdown.value },
            price: document.getElementById("price").value,
            validity: document.getElementById("validity").value,
            calls: document.getElementById("calls").value,
            data: document.getElementById("data").value,
            message: document.getElementById("sms").value,
            additionalFeature: document.getElementById("additionalFeatures").value,
            tag: document.getElementById("tag").value
        };
        fetch(`${API_URL}/plans/add`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newPlan)
        })
        .then(response => response.text())
        .then(() => {
            fetchPlans();
            let modal = bootstrap.Modal.getInstance(document.getElementById("addPlanModal"));
            modal.hide();
            addPlanForm.reset();
        })
        .catch(error => console.error("Error adding plan:", error));
    });

    // Open Edit Modal and Load Plan Data
    document.addEventListener("click", function (event) {
        if (event.target.classList.contains("edit-plan")) {
            const planId = event.target.getAttribute("data-id");
            fetch(`${API_URL}/plans/${planId}`)
                .then(response => response.json())
                .then(plan => {
                    currentPlanId = plan.planId;
                    editPlanId.value = plan.planId;
                    editCategoryType.value = plan.category.categoryId;
                    editPrice.value = plan.price;
                    editData.value = plan.data;
                    editCalls.value = plan.calls;
                    editSms.value = plan.message;
                    editValidity.value = plan.validity;
                    editAdditionalFeatures.value = plan.additionalFeature;
                    editTag.value = plan.tag;
                })
                .catch(error => console.error("Error fetching plan details:", error));
        }
    });

    // Save Edited Plan
    editPlanForm.addEventListener("submit", function (event) {
        event.preventDefault();
        const updatedPlan = {
            category: { categoryId: editCategoryType.value },
            price: editPrice.value,
            validity: editValidity.value,
            calls: editCalls.value,
            data: editData.value,
            message: editSms.value,
            additionalFeature: editAdditionalFeatures.value,
            tag: editTag.value
        };

        fetch(`${API_URL}/plans/update/${currentPlanId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updatedPlan)
        })
        .then(response => response.text())
        .then(() => {
            fetchPlans();
            let modal = bootstrap.Modal.getInstance(document.getElementById("editPlanModal"));
            modal.hide();
        })
        .catch(error => console.error("Error updating plan:", error));
    });

    // Activate or Deactivate Plan
    document.addEventListener("click", function (event) {
        if (event.target.classList.contains("toggle-status")) {
            const planId = event.target.getAttribute("data-id");
            const currentStatus = event.target.getAttribute("data-status");
            const newStatus = currentStatus === "ACTIVE" ? "inactive" : "active";
            fetch(`${API_URL}/plans/${planId}/${newStatus}`, { method: "PUT" })
                .then(() => fetchPlans())
                .catch(error => console.error("Error updating plan status:", error));
        }
    });

    // Initial Load
    fetchCategories();
    fetchPlans();
});

</script>


</body>
</html>  