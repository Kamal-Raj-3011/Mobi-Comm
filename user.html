<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Language" content="en">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobi-Comm - All Users</title>
    <link rel="stylesheet" href="assets/css/user.css">
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <script src="node_modules/@popperjs/core/dist/umd/popper.min.js"></script>
    <style>
        @media (max-width: 991px) {
            #sidebar {
                display: none;
            }
            .container-fluid {
                margin-left: 0 !important;
                max-width: 100% !important;
            }
        }

        
    </style>
</head>

<body>
<!-- Sidebar (Offcanvas for Mobile) -->
<div class="offcanvas offcanvas-start d-lg-none bg-dark text-white p-4 shadow-lg" id="offcanvasSidebar" style="width: 250px;">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title text-info"><i class="fas fa-user-shield me-2"></i> Admin Panel</h5>
        <button type="button" class="btn-close text-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <div class="list-group">
            <a href="admindashboard.html" class="list-group-item list-group-item-action d-flex align-items-center gap-2">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="user.html" class="list-group-item active list-group-item-action d-flex align-items-center gap-2">
                <i class="fas fa-users"></i> All Users
            </a>
            <a href="planmanagement.html" class="list-group-item  list-group-item-action d-flex align-items-center gap-2">
                <i class="fas fa-list-alt"></i> Plan Management
            </a>
            <a href="adminreport.html" class="list-group-item  list-group-item-action d-flex align-items-center gap-2">
                <i class="fas fa-list-alt"></i> Report
            </a>
        </div>
    </div>
</div>

<!-- Sidebar (Fixed for Large Screens) -->
<div class="d-none d-lg-block bg-dark text-white p-4 shadow-lg" id="sidebar" style="width: 250px; min-height: 100vh; position: fixed;">
    <h3 class="text-center py-3 text-info"><i class="fas fa-user-shield me-2"></i> Admin Panel</h3>
    <div class="list-group">
        <a href="admindashboard.html" class="list-group-item list-group-item-action d-flex align-items-center gap-2">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a href="user.html" class="list-group-item active list-group-item-action d-flex align-items-center gap-2">
            <i class="fas fa-users"></i> All Users
        </a>
        <a href="planmanagement.html" class="list-group-item  list-group-item-action d-flex align-items-center gap-2">
            <i class="fas fa-list-alt"></i> Plan Management
        </a>
        <a href="adminreport.html" class="list-group-item  list-group-item-action d-flex align-items-center gap-2">
            <i class="fas fa-list-alt"></i> Report
        </a>
    </div>
</div>

    <!-- Page Content -->
    <div class="container-fluid" style="margin-left: 238px; max-width: calc(100% - 240px);">
        <nav class="navbar navbar-dark bg-dark">
            <div class="container-fluid">
                <button class="btn btn-dark d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <a class="navbar-brand" href="home.html">Mobi-Comm</a>
                <div class="dropdown">
                    <button class="btn btn-dark dropdown-toggle" type="button" id="adminDropdown" data-bs-toggle="dropdown">
                        Admin Profile
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="admin.html">Logout</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Sidebar as Offcanvas in Mobile -->
        <div class="offcanvas offcanvas-start text-white bg-dark" id="offcanvasSidebar">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title">Admin Panel</h5>
                <button type="button" class="btn-close text-white" data-bs-dismiss="offcanvas"></button>
            </div>
            <div class="offcanvas-body">
                <div class="list-group">
                    <a href="admindashboard.html" class="list-group-item list-group-item-action bg-dark text-white">Dashboard</a>
                    <a href="user.html" class="list-group-item list-group-item-action bg-dark text-white">All Users</a>
                    <a href="planmanagement.html" class="list-group-item list-group-item-action bg-dark text-white">Plan Management</a>
                </div>
            </div>
        </div>

        <div class="container">
            <h4 class="text-center py-3">All User Details</h4>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>S.No</th>
                            <th>Name</th>
                            <th>Mobile Number</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody"></tbody>
                </table>
                <nav>
                    <ul class="pagination justify-content-center" id="pagination"></ul>
                </nav>
            </div>
        </div>

<!-- Offcanvas for Viewing User Details -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="userDetailsOffcanvas" aria-labelledby="userDetailsOffcanvasLabel">
    <div class="offcanvas-header p-4" style="background: linear-gradient(135deg, #0062E6, #33AEFF);">
      <h5 class="offcanvas-title text-white" id="userDetailsOffcanvasLabel"><i class="fas fa-user-circle"></i> User Details</h5>
      <button type="button" class="btn-close text-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-4">
      <div id="userDetailsContent">
        <!-- User details section with cards for each detail -->
        <div class="row mb-4">
          <div class="col-12 col-md-6">
            <div class="card shadow-sm border-0 rounded-3">
              <div class="card-body">
                <h6 class="card-title text-muted">Name</h6>
                <p id="userName" class="h6 font-weight-bold"></p>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="card shadow-sm border-0 rounded-3">
              <div class="card-body">
                <h6 class="card-title text-muted">Mobile Number</h6>
                <p id="userMobileNo" class="h6 font-weight-bold"></p>
              </div>
            </div>
          </div>
        </div>
  
        <div class="row mb-4">
          <div class="col-12 col-md-6">
            <div class="card shadow-sm border-0 rounded-3">
              <div class="card-body">
                <h6 class="card-title text-muted">Email</h6>
                <p id="userEmail" class="h6 font-weight-bold"></p>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="card shadow-sm border-0 rounded-3">
              <div class="card-body">
                <h6 class="card-title text-muted">Address</h6>
                <p id="userAddress" class="h6 font-weight-bold"></p>
              </div>
            </div>
          </div>
        </div>
  
  
        <hr class="my-4">
        
        <!-- Previous plans section with animated list -->
        <h6 class="text-primary mb-3"><strong>Previous Plans:</strong></h6>
        <ul id="previousPlansList" class="list-group">
          <!-- Previous plans will be populated here -->
        </ul>
      </div>
    </div>
  </div>
  
  
  
  

    </div>

    <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <script>
document.addEventListener("DOMContentLoaded", function () {
    // Define the API URLs
    const usersApiUrl = "http://127.0.0.1:9090/api/users/all"; // Adjust if necessary
    const rechargesApiUrl = "http://127.0.0.1:9090/api/recharges/user/";
    const transactionsApiUrl = "http://127.0.0.1:9090/api/transactions/user/";

    const userTableBody = document.getElementById("userTableBody");
    const pagination = document.getElementById("pagination");

    // Fetch Users
    function fetchUsers() {
        fetch(usersApiUrl)
            .then(response => response.json())
            .then(users => {
                if (users.length === 0) {
                    userTableBody.innerHTML = "<tr><td colspan='5' class='text-center'>No users found</td></tr>";
                } else {
                    displayUserDetails(users);
                    setupPagination(users);
                }
            })
            .catch(error => console.log('Error fetching users:', error));
    }

    // Display User Details in Table
    function displayUserDetails(users) {
        userTableBody.innerHTML = "";
        users.forEach((user) => {
            const row = document.createElement("tr");

            
            const userIdCell = document.createElement("td");
            userIdCell.textContent = user.userId || "N/A";
            row.appendChild(userIdCell);

            const userNameCell = document.createElement("td");
            userNameCell.textContent = user.name || "N/A";
            row.appendChild(userNameCell);

            const userMobileCell = document.createElement("td");
            userMobileCell.textContent = user.mobileNo || "N/A";
            row.appendChild(userMobileCell);

            const actionCell = document.createElement("td");
            actionCell.classList.add("text-center");
            const actionButton = document.createElement("button");
            actionButton.classList.add("btn", "btn-primary");
            actionButton.textContent = "View Details";
            actionButton.onclick = () => openUserDetailsOffcanvas(user);  // Open offcanvas on click
            actionCell.appendChild(actionButton);
            row.appendChild(actionCell);

            userTableBody.appendChild(row);
        });
    }

    // Open Offcanvas and Fetch User Details and Previous Plans
    function openUserDetailsOffcanvas(user) {
        // Set user details in offcanvas
        document.getElementById("userName").textContent = user.name;
        document.getElementById("userMobileNo").textContent = user.mobileNo;
        document.getElementById("userEmail").textContent = user.emailId;
        document.getElementById("userAddress").textContent = user.address;

        // Fetch and display previous plans
        fetchPreviousPlans(user.userId);
        
        // Show the offcanvas
        let myOffcanvas = new bootstrap.Offcanvas(document.getElementById('userDetailsOffcanvas'));
        myOffcanvas.show();
    }

    // Fetch Previous Plans for the User
    function fetchPreviousPlans(userId) {
        fetch(`${rechargesApiUrl}${userId}`)
            .then(response => response.json())
            .then(recharges => {
                // Display previous plans in the offcanvas
                displayPreviousPlans(recharges);
            })
            .catch(error => console.log('Error fetching recharges:', error));
    }

    // Display Previous Plans in the Offcanvas
    function displayPreviousPlans(recharges) {
        const previousPlansList = document.getElementById("previousPlansList");
        previousPlansList.innerHTML = "";  // Clear the previous plans list

        if (recharges.length === 0) {
            previousPlansList.innerHTML = "<li class='list-group-item text-center'>No previous plans found.</li>";
        } else {
            recharges.forEach((recharge) => {
                const plan = recharge.plan; // Access the plan object within the recharge

                // Check if plan exists and then access its details
                if (plan) {
                    const listItem = document.createElement("li");
                    listItem.classList.add("list-group-item", "my-3", "border-0", "p-3", "rounded-3", "shadow-sm");
                    listItem.innerHTML = `
                        <strong>Plan ID:</strong> ${plan.planId} <br>
                        <strong>Plan Name:</strong> ${plan.category.categoryName} <br>
                        <strong>Price:</strong> â‚¹${plan.price} <br>
                        <strong>Validity:</strong> ${plan.validity} days <br>
                        <strong>Expiry Date:</strong> ${new Date(recharge.expiryDate).toLocaleDateString()} <br>
                    `;
                    previousPlansList.appendChild(listItem);
                } else {
                    const listItem = document.createElement("li");
                    listItem.classList.add("list-group-item", "border-0", "p-3", "rounded-3", "shadow-sm");
                    listItem.textContent = "No plan data available for this recharge.";
                    previousPlansList.appendChild(listItem);
                }
            });
        }
    }

    // Fetch users on page load
    fetchUsers();
});

    </script>
</body> 
</html>
